/*
 * jArcherTarget plugin "appZoom" - version 0.2 [2012-09-23]
 * This plugin shows a zoom target if an arrow is moving. Created for use in smartphone applications.
 *
 * Copyright 2012, Andre Meyering
 * Licensed under the MIT license.
 */(function(e){e.fn.archerTarget("addPlugin","appZoom",{initialize:function(t,n){var r=this,i,s;r.movingArrow=!1,r.mainTarget=t,r.mainTarget.defaultZoom=r.mainTarget.zoom,r.options=e.extend(!0,{},r.defaults,n),i=r.mainTarget.width,s=r.mainTarget.height,r.mainTarget.defaultTransX=i/2/r.mainTarget.defaultZoom-i/2,r.mainTarget.defaultTransY=s/2/r.mainTarget.defaultZoom-s/2,r.mainTarget.scaledTransX=i/2/r.options.tapZoom-i/2,r.mainTarget.scaledTransY=s/2/r.options.tapZoom-s/2,r.mainTarget.setTransform(r.mainTarget.defaultTransX,r.mainTarget.defaultTransY),r.scaledTarget={},r.scaledTarget.width=i*r.options.scaledZoom,r.scaledTarget.height=s*r.options.scaledZoom,r.scaledTarget.wrapperWidth=i/100*r.options.width,r.scaledTarget.wrapperHeight=s/100*r.options.height,r.scaledTarget.defaultTransX=-(r.scaledTarget.width/2-r.scaledTarget.wrapperWidth/(2*r.mainTarget.defaultZoom)),r.scaledTarget.defaultTransY=-(r.scaledTarget.height/2-r.scaledTarget.wrapperHeight/(2*r.mainTarget.defaultZoom)),r.createScaledTarget()},defaults:{backgroundColor:"#ccc",scaledZoom:2.5,tapZoom:1.5,width:100,height:30,crossWidth:2,crossColor:"#000",margin:{}},createScaledTarget:function(){var t=this,n={target:t.mainTarget.target,zoomable:!1,draggable:!1,zoom:t.mainTarget.zoom,backgroundColor:t.options.backgroundColor,transX:t.scaledTarget.defaultTransX,transY:t.scaledTarget.defaultTransY};t.mainTarget.container.on("arrowSelect.jArcherTarget",function(e,n,r,i){t.onArrowSelect(n,r,i)}).on("arrowDeselect.jArcherTarget",function(e,n,r,i){t.onArrowDeselect(n,r,i)}).on("arrowMove.jArcherTarget",function(e,n,r,i){t.onArrowMove(n,r,i)}),!t.options.margin.bottom&&t.options.margin.bottom!==0&&(t.options.margin.bottom=t.scaledTarget.wrapperHeight),t.scaledTarget.container=e("<div/>").attr("id",t.mainTarget.container[0].id+"ScaledTarget").css({width:t.scaledTarget.width,height:t.scaledTarget.height,"z-index":980}).archerTarget(n),t.scaledTarget.wrapper=e("<div/>").attr("id",t.mainTarget.container[0].id+"ScaledTargetWrapper").css({width:t.scaledTarget.wrapperWidth,height:t.scaledTarget.wrapperHeight,overflow:"hidden","margin-bottom":t.options.margin.bottom*-1+"px"}).append(t.createCross()).append(t.scaledTarget.container).hide(),t.mainTarget.container.before(t.scaledTarget.wrapper)},createCross:function(){var t=this,n=e("<div/>").attr("id",t.mainTarget.container[0].id+"Cross").append(e("<div/>").css({"border-bottom":t.options.crossWidth+"px solid "+t.options.crossColor,width:t.scaledTarget.wrapperWidth,height:(t.scaledTarget.wrapperHeight-t.options.crossWidth/2)/2}).css({position:"absolute"})).append(e("<div/>").css({"border-right":t.options.crossWidth+"px solid "+t.options.crossColor,width:(t.scaledTarget.wrapperWidth-t.options.crossWidth/2)/2,height:t.scaledTarget.wrapperHeight}).css({position:"absolute"})).css({"z-index":990,position:"relative",top:0,left:0});return n},onArrowSelect:function(e,t,n){if(n[e].draggable==0)return!1;this.arrows=n;var r=this,i=n[e].data[t].element,s={x:parseInt(i.getAttribute("cx"),10),y:parseInt(i.getAttribute("cy"),10)},o={x:r.mainTarget.width/2-s.x,y:r.mainTarget.height/2-s.y};r.movingArrow=!0,r.scaledTarget.wrapper.show(),r.mainTarget.container.archerTarget("set","transform",r.mainTarget.scaledTransX+o.x/r.mainTarget.defaultZoom-o.x/r.options.tapZoom,r.mainTarget.scaledTransY+o.y/r.mainTarget.defaultZoom-o.y/r.options.tapZoom,r.options.tapZoom);var u=function(){r.setScaledTarget(e,t,r.arrows)};cancelAnimationFrame(u),requestAnimationFrame(u),window.webkitRequestAnimationFrame&&requestAnimationFrame(u)},onArrowDeselect:function(e,t,n){var r=this;r.scaledTarget.wrapper.hide(),r.mainTarget.container.archerTarget("set","transform",r.mainTarget.defaultTransX,r.mainTarget.defaultTransY,r.mainTarget.defaultZoom),r.arrows=n,r.movingArrow=!1},onArrowMove:function(e,t,n){this.arrows=n},setScaledTarget:function(e,t,n){var r=this;if(r.movingArrow){var i=n[e].data[t].element,s={x:parseInt(i.getAttribute("cx"),10),y:parseInt(i.getAttribute("cy"),10)},o=r.mainTarget,u=r.mainTarget.zoom,a=o.width,f=o.height,l=o.transX,c=o.transY,h=o.scaledTransX,p=o.scaledTransY,d={x:a/2-s.x-(h-l)*u,y:f/2-s.y-(p-c)*u},v=function(e){s.y<r.options.margin.bottom+20&&c<p+f/2/u+r.options.margin.bottom?(c+=2,r.mainTarget.setTransform(l,c)):s.y>f-20&&c>p+f/-2/u&&(c-=2,r.mainTarget.setTransform(!1,c)),s.x<20&&l<h+a/2/u?(l+=2,r.mainTarget.setTransform(l,c)):s.x>a-20&&l>h+a/-2/u&&(l-=2,r.mainTarget.setTransform(l,c)),r.scaledTarget.container.archerTarget("set","transform",r.scaledTarget.defaultTransX+d.x/(u/r.options.scaledZoom),r.scaledTarget.defaultTransY+d.y/(u/r.options.scaledZoom))};v(),requestAnimationFrame(function(){r.setScaledTarget(e,t,r.arrows)})}}})})(jQuery);