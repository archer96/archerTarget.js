/*
 * jArcherTarget plugin "appZoom2" - version 0.2 [2012-01-14]
 * This plugin shows a zoomed target if an arrow is moving. Created for use in smartphone applications.
 *
 * Copyright 2012, Andre Meyering
 * Licensed under the MIT license.
 */(function(e){e.fn.archerTarget("addPlugin","appZoom2",{initialize:function(t,n){var r=this,i,s;r.movingArrow=!1,r.mainTarget=t,r.mainTarget.defaultZoom=r.mainTarget.zoom,r.options=e.extend(!0,{},r.defaults,n),i=r.mainTarget.width,s=r.mainTarget.height,r.mainTarget.defaultTransX=i/2/r.mainTarget.defaultZoom-i/2,r.mainTarget.defaultTransY=s/2/r.mainTarget.defaultZoom-s/2,r.mainTarget.scaledTransX=i/2/r.options.tapZoom-i/2,r.mainTarget.scaledTransY=s/2/r.options.tapZoom-s/2,r.mainTarget.setTransform(r.mainTarget.defaultTransX,r.mainTarget.defaultTransY),r.scaledTarget={},r.scaledTarget.width=i*r.options.scaledZoom,r.scaledTarget.height=s*r.options.scaledZoom,r.scaledTarget.wrapperWidth=i/100*r.options.width,r.scaledTarget.wrapperHeight=r.options.useHeightPx?r.options.height:s/100*r.options.height,r.scaledTarget.defaultTransX=-(r.scaledTarget.width/2-r.scaledTarget.wrapperWidth/(2*r.mainTarget.defaultZoom)),r.scaledTarget.defaultTransY=-(r.scaledTarget.height/2-r.scaledTarget.wrapperHeight/(2*r.mainTarget.defaultZoom)),r.resetCrossPosition(),r.createScaledTarget()},defaults:{backgroundColor:"#ccc",scaledZoom:2.5,tapZoom:1.5,width:100,height:30,crossWidth:2,crossColor:"#000",margin:{}},createScaledTarget:function(){var t=this,n={target:t.mainTarget.target,zoomable:!1,draggable:!1,zoom:t.mainTarget.zoom,backgroundColor:t.options.backgroundColor,transX:t.scaledTarget.defaultTransX,transY:t.scaledTarget.defaultTransY};t.mainTarget.container.on("arrowSelect.jArcherTarget",function(e,n,r,i){t.onArrowSelect(n,r,i)}).on("arrowDeselect.jArcherTarget",function(e,n,r,i){t.onArrowDeselect(n,r,i)}).on("arrowMove.jArcherTarget",function(e,n,r,i){t.onArrowMove(n,r,i)}),!t.options.margin.bottom&&t.options.margin.bottom!==0&&(t.options.margin.bottom=t.scaledTarget.wrapperHeight),t.createCross(),t.scaledTarget.container=e("<div/>").attr("id",t.mainTarget.container[0].id+"ScaledTarget").css({width:t.scaledTarget.width,height:t.scaledTarget.height,"z-index":980}).archerTarget(n),t.scaledTarget.wrapper=e("<div/>").attr("id",t.mainTarget.container[0].id+"ScaledTargetWrapper").css({width:t.scaledTarget.wrapperWidth,height:t.scaledTarget.wrapperHeight,overflow:"hidden","margin-bottom":t.options.margin.bottom*-1+"px"}).append(t.cross).append(t.scaledTarget.container).hide(),t.mainTarget.container.before(t.scaledTarget.wrapper)},createCross:function(){var t=this;t.crossXEl=e('<div class="crossX"></div>').css({"border-bottom":t.options.crossWidth+"px solid "+t.options.crossColor,width:t.scaledTarget.wrapperWidth,height:t.crossY,position:"absolute"}),t.crossYEl=e('<div class="crossY"></div>').css({"border-right":t.options.crossWidth+"px solid "+t.options.crossColor,width:t.crossY,height:t.scaledTarget.wrapperHeight,position:"absolute"}),t.cross=e("<div/>").attr("id",t.mainTarget.container[0].id+"Cross").append(t.crossYEl).append(t.crossXEl).css({"z-index":990,position:"relative",top:0,left:0})},onArrowSelect:function(e,t,n){if(n[e].draggable==0)return!1;this.arrows=n;var r=this,i=r.getArrowPosition(e,t),s={x:r.mainTarget.width/2-i.x,y:r.mainTarget.height/2-i.y};r.movingArrow=!0,r.activeArrowID=t,r.activeArrowSetID=e,r.scaledTarget.wrapper.show(),r.mainTarget.container.archerTarget("set","transform",r.mainTarget.scaledTransX+s.x/r.mainTarget.defaultZoom-s.x/r.options.tapZoom,r.mainTarget.scaledTransY+s.y/r.mainTarget.defaultZoom-s.y/r.options.tapZoom,r.options.tapZoom),r.arrowOldX=i.x,r.arrowOldY=i.y,r.movingController(e,t,!0)},onArrowDeselect:function(e,t,n){var r=this;r.scaledTarget.wrapper.hide(),r.mainTarget.container.archerTarget("set","transform",r.mainTarget.defaultTransX,r.mainTarget.defaultTransY,r.mainTarget.defaultZoom),r.resetCrossPosition(),r.arrows=n,r.movingArrow=!1},onArrowMove:function(e,t,n){this.arrows=n},movingController:function(e,t,n){if(!this.movingArrow)return;var r=this,i=r.mainTarget,s=r.getArrowPosition(e,t),o={x:i.width/2-s.x-(i.scaledTransX-i.transX)*r.mainTarget.zoom,y:i.height/2-s.y-(i.scaledTransY-i.transY)*r.mainTarget.zoom};n&&r.setScaledTarget(o),r.setCrossPosition(s.x,s.y),r.checkMoving(e,t),requestAnimationFrame(function(){r.movingController(e,t,!1)})},setCrossPosition:function(e,t){var n=this,r=n.scaledTarget.wrapperWidth/2-(n.arrowOldX-e)/(n.mainTarget.zoom/n.options.scaledZoom),i=n.scaledTarget.wrapperHeight/2-(n.arrowOldY-t)/(n.mainTarget.zoom/n.options.scaledZoom);n.crossX=r-n.options.crossWidth/2,n.crossY=i-n.options.crossWidth/2,n.crossXEl.css({height:n.crossY}),n.crossYEl.css({width:n.crossX})},setScaledTarget:function(e){var t=this,n=t.scaledTarget.defaultTransX+e.x/(t.mainTarget.zoom/t.options.scaledZoom),r=t.scaledTarget.defaultTransY+e.y/(t.mainTarget.zoom/t.options.scaledZoom);n+=t.crossX-t.crossOrgX,r+=t.crossY-t.crossOrgY,t.scaledTarget.container.archerTarget("set","transform",n,r)},getArrowPosition:function(e,t){var n=this.arrows[e].data[t].element;return{x:parseInt(n.getAttribute("cx"),10),y:parseInt(n.getAttribute("cy"),10)}},resetCrossPosition:function(){var e=this;e.crossX=e.crossOrgX=(e.scaledTarget.wrapperWidth-e.options.crossWidth/2)/2,e.crossY=e.crossOrgY=(e.scaledTarget.wrapperHeight-e.options.crossWidth/2)/2},checkMoving:function(e,t){var n=this;arrow=n.getArrowPosition(e,t),hasMoved=!1,main=n.mainTarget,mainZoom=n.mainTarget.zoom,mainWidth=main.width,mainHeight=main.height,mainTransX=main.transX,mainTransY=main.transY,mainScaledTransX=main.scaledTransX,mainScaledTransY=main.scaledTransY,arrow.y<n.options.margin.bottom+20?(mainTransY+=1,hasMoved=!0):arrow.y>mainHeight-20&&(mainTransY-=1,hasMoved=!0),arrow.x<20?(mainTransX+=1,hasMoved=!0):arrow.x>mainWidth-20&&(mainTransX-=1,hasMoved=!0);if(hasMoved){n.mainTarget.setTransform(mainTransX,mainTransY);var r={x:main.width/2-arrow.x-(main.scaledTransX-main.transX)*main.zoom,y:main.height/2-arrow.y-(main.scaledTransY-main.transY)*main.zoom};n.setScaledTarget(r,!0)}}})})(jQuery);